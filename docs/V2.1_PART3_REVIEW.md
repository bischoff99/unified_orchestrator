# Part 3: Testing + CI + Docs - Comprehensive Review

**Date:** 2025-10-22  
**Status:** Pre-Implementation Review  
**Tasks:** 16 tasks across 5 phases  
**Estimated Effort:** 2-3 hours

---

## üìä Overview

Part 3 focuses on test coverage, CI/CD improvements, and comprehensive documentation. It's the final piece to make v2.1 production-ready.

### Task Breakdown
- **Phase H**: FileStore Tests (2 tasks)
- **Phase I**: Resume Tests (2 tasks)  
- **Phase J**: Retry/Circuit Breaker Tests (2 tasks) ‚ö†Ô∏è **BLOCKED by Part 2**
- **Phase K**: Cache Tests (2 tasks)
- **Phase L**: CI Polish (3 tasks)
- **Phase M**: Configuration (1 task)
- **Phase N**: Documentation (5 tasks)

---

## üîç Current State Analysis

### ‚úÖ What Already Exists

#### Test Infrastructure
```bash
tests/
‚îú‚îÄ‚îÄ test_filestore.py       ‚úÖ EXISTS (needs enhancement)
‚îú‚îÄ‚îÄ test_cache.py           ‚úÖ EXISTS (empty, needs implementation)
‚îú‚îÄ‚îÄ test_dag.py             ‚úÖ EXISTS (has basic tests)
‚îú‚îÄ‚îÄ test_manifest.py        ‚úÖ EXISTS
‚îú‚îÄ‚îÄ test_golden.py          ‚úÖ EXISTS
‚îî‚îÄ‚îÄ golden/
    ‚îî‚îÄ‚îÄ fastapi_notes_main.py
```

#### CI/CD
```yaml
.github/workflows/ci.yml    ‚úÖ EXISTS
- Pip caching: ‚úÖ ALREADY IMPLEMENTED (lines 28-35, 84-91)
- Artifact upload: ‚úÖ ALREADY IMPLEMENTED (lines 159-165)
- Golden tests: ‚úÖ ALREADY RUN (lines 52-55)
- Matrix: ‚úÖ ubuntu-latest, macos-latest, Python 3.11/3.12
- Coverage: ‚úÖ codecov integration
```

#### Core Systems (from Part 1)
- ‚úÖ Events system with typed schema
- ‚úÖ Resume functionality in DAG
- ‚úÖ Deterministic cache with versioning
- ‚úÖ Manifest with completed_steps tracking

### ‚ùå What's Missing

#### Tests (8 new/enhanced tests)
- ‚ùå `test_filestore.py`: idempotency and nochange tests
- ‚ùå `tests/test_resume.py`: NEW FILE - resume functionality
- ‚ùå `tests/test_retries.py`: NEW FILE - provider retries (**BLOCKED**)
- ‚ùå `tests/test_cache.py`: cache key determinism + cache hits

#### FileStore Enhancements
- ‚ùå `src/core/filestore.py`: Return metadata dict `{path, sha256, wrote, reason}`
- ‚ùå `src/core/filestore.py`: Accept EventEmitter, emit file.written events

#### Configuration
- ‚ùå `.env.example`: Provider config vars (TIMEOUT_S, MAX_RETRIES, CB_*)

#### Documentation (5 files)
- ‚ùå `docs/ARCHITECTURE.md`
- ‚ùå `docs/MIGRATION_v1_to_v2.md`
- ‚ùå `CONTRIBUTING.md`
- ‚ùå `CHANGELOG.md`
- ‚ùå `README.md`: Update for v2.1 features

---

## ‚ö†Ô∏è Critical Issues & Dependencies

### üö´ Blocker: Part 2 Dependency

**Phase J (Retry/Circuit Breaker Tests) is BLOCKED:**

```python
# tests/test_retries.py requires:
- src/core/circuit_breaker.py (Part 2)
- Provider retry logic (Part 2)
- Provider timeout configuration (Part 2)
```

**Impact:**
- 2 tasks out of 16 cannot be implemented until Part 2 is complete
- Represents 12.5% of Part 3 work

**Recommendation:**
- **Skip Phase J** during Part 3 implementation
- Implement Phase J after Part 2 completion
- Adjust commit strategy accordingly

### üîß FileStore Signature Change

**Current signature:**
```python
def safe_write(path, content, mode) -> tuple[Path, str, int]:
    # Returns: (path, sha256, size_bytes)
```

**Proposed v2.1 signature:**
```python
def safe_write(path, content, mode, events: Optional[EventEmitter] = None) -> dict:
    # Returns: {path, sha256, size_bytes, wrote: bool, reason: str}
```

**Impact:**
- ‚ö†Ô∏è **BREAKING CHANGE** for existing code
- Affects: `dag_orchestrator.py` (3 calls), any custom code
- Need migration path or backward compatibility

**Recommendation:**
- Use deprecation pattern:
  - Add new parameter with default `None`
  - Return dict but maintain tuple unpacking compatibility temporarily
  - Log deprecation warning for tuple unpacking
  - Document migration in MIGRATION.md

### üìù CI Already Complete?

**Good News:** CI polish (Phase L) is **mostly done**:
- ‚úÖ Pip caching implemented with proper cache keys
- ‚úÖ Artifact upload on failure
- ‚úÖ Golden tests run explicitly (ubuntu + 3.11 only)

**Minor Gap:**
- Golden tests run only on ubuntu-latest + Python 3.11
- Consider: Run on all matrix combinations? (adds time/cost)

**Recommendation:**
- Mark Phase L as "verify + minor polish" instead of "implement"
- Add explicit `pytest tests/test_golden.py` step for visibility
- Document why golden tests run once (deterministic output)

---

## üéØ Recommended Implementation Order

### Strategy: Bottom-Up (Infrastructure ‚Üí Tests ‚Üí Docs)

#### Wave 1: Foundation (Est: 30 min)
```
1. env-example-file          ‚Üí Configuration baseline
2. filestore-return-metadata ‚Üí Enable event integration
3. filestore-emit-events     ‚Üí Complete FileStore v2.1
```

#### Wave 2: Tests - Part 1 Features (Est: 45 min)
```
4. test-filestore-idempotency  ‚Üí Verify FileStore behavior
5. test-filestore-nochange     ‚Üí 
6. test-resume-file            ‚Üí Verify resume functionality
7. test-resume-integration     ‚Üí
8. test-cache-file             ‚Üí Verify cache determinism
9. test-cache-hits             ‚Üí
```

#### Wave 3: CI Verification (Est: 15 min)
```
10. ci-pip-cache      ‚Üí Already done, document
11. ci-artifact-upload ‚Üí Already done, verify
12. ci-golden-explicit ‚Üí Add explicit step label
```

#### Wave 4: Documentation (Est: 60 min)
```
13. changelog-file         ‚Üí Quick (templated)
14. env-example-doc        ‚Üí Quick (list vars)
15. architecture-doc-file  ‚Üí Medium (explain systems)
16. migration-doc-file     ‚Üí Medium (breaking changes)
17. contributing-doc-file  ‚Üí Medium (dev workflow)
18. readme-update-v21      ‚Üí Quick (feature list)
```

**Total Est:** 2.5 hours (excluding blocked Phase J)

---

## üìã Task-by-Task Analysis

### Phase H: FileStore Tests ‚úÖ READY

#### test-filestore-idempotency
**Goal:** Verify writing same content twice doesn't change hash  
**Current State:** `test_filestore.py` has basic tests  
**Action:** Add test that writes content, checks hash, writes again, verifies hash unchanged

```python
def test_idempotency_preserves_manifest_hash():
    store = FileStore(Path("/tmp/test"))
    
    # First write
    result1 = store.safe_write("test.txt", "content", mode="overwrite")
    hash1 = result1["sha256"]
    
    # Second write (same content)
    result2 = store.safe_write("test.txt", "content", mode="overwrite")
    hash2 = result2["sha256"]
    
    assert hash1 == hash2
    assert result2["wrote"] == False
    assert result2["reason"] == "nochange"
```

**Risk:** Low  
**Dependencies:** FileStore metadata return (Wave 1)

#### test-filestore-nochange
**Goal:** Verify `wrote=False` and `reason="nochange"` returned  
**Similar to above, focuses on return value structure**

**Risk:** Low  
**Dependencies:** FileStore metadata return (Wave 1)

---

### Phase I: Resume Tests ‚úÖ READY

#### test-resume-file
**Goal:** Verify `resume=True` skips completed steps

**Strategy:**
1. Create mock events.jsonl with step.succeeded for "architect"
2. Build DAG with architect ‚Üí builder ‚Üí qa
3. Call `run_dag(resume=True)`
4. Assert architect NOT executed (check mock call count)
5. Assert builder and qa ARE executed

**Complexity:** Medium (requires mocking)  
**Risk:** Medium (DAG internals complex)  
**Est Time:** 20 min

#### test-resume-integration
**Goal:** Simulate failure mid-run, then resume

**Strategy:**
1. Run DAG that fails at step 2
2. Verify events.jsonl has step.succeeded for step 1
3. Run same DAG with `resume=True`
4. Verify step 1 skipped (step.skipped event)
5. Verify step 2+ execute normally

**Complexity:** High (failure injection)  
**Risk:** Medium  
**Est Time:** 25 min

---

### Phase J: Retry/Circuit Breaker Tests ‚ö†Ô∏è BLOCKED

**Status:** Cannot implement until Part 2 provides:
- `src/core/circuit_breaker.py`
- Provider retry wrappers with tenacity
- Provider timeout configuration

**Recommendation:** DEFER to Part 2 completion

---

### Phase K: Cache Tests ‚úÖ READY

#### test-cache-file (test_cache_key_deterministic)
**Goal:** Verify same inputs ‚Üí same cache key

```python
def test_cache_key_deterministic():
    key1 = compute_cache_key(
        provider={"name": "ollama", "model": "llama3", "opts": {}},
        step_id="architect",
        inputs={"task": "Build todo app"},
        code_version="abc123"  # Fixed version
    )
    
    key2 = compute_cache_key(
        provider={"name": "ollama", "model": "llama3", "opts": {}},
        step_id="architect",
        inputs={"task": "Build todo app"},
        code_version="abc123"
    )
    
    assert key1 == key2
    assert len(key1) == 64  # SHA256 hex
```

**Complexity:** Low  
**Risk:** Low  
**Est Time:** 10 min

#### test-cache-hits
**Goal:** Verify second run uses cache (cache.hit event)

**Strategy:**
1. Mock provider, run orchestrator step
2. Verify cache.miss event emitted
3. Run again with same inputs
4. Verify cache.hit event emitted
5. Verify provider NOT called second time

**Complexity:** Medium (event assertions)  
**Risk:** Low  
**Est Time:** 15 min

---

### Phase L: CI Polish ‚ö†Ô∏è MOSTLY DONE

**Current State Analysis:**

```yaml
# ‚úÖ Pip caching - ALREADY IMPLEMENTED (lines 28-35)
- name: Cache pip
  uses: actions/cache@v4
  with:
    path: ~/.cache/pip
    key: pip-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('...') }}
```

```yaml
# ‚úÖ Artifact upload - ALREADY IMPLEMENTED (lines 159-165)
- name: Upload run artifacts
  if: failure()
  uses: actions/upload-artifact@v4
  with:
    name: runs-${{ github.run_id }}-${{ github.job }}
    path: runs/
```

```yaml
# ‚úÖ Golden tests - ALREADY RUN (lines 52-55)
- name: Run golden tests
  if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
  run: |
    pytest tests/test_golden.py -q
```

**Needed Changes:** MINIMAL
- Add explicit step name for visibility
- Verify cache key includes all relevant files
- Confirm artifact upload includes new test outputs

**Est Time:** 15 min (verification only)

---

### Phase M: Configuration ‚úÖ READY

#### env-example-file
**Goal:** Create `.env.example` with all provider config

```bash
# .env.example

# Provider Configuration
PROVIDER=ollama
PROVIDER_MODEL=llama3

# Reliability Settings
PROVIDER_TIMEOUT_S=60
PROVIDER_MAX_RETRIES=3

# Circuit Breaker (Part 2)
PROVIDER_CB_THRESHOLD=5
PROVIDER_CB_COOLDOWN_S=30

# Orchestrator Settings
CONCURRENCY=4
```

**Complexity:** Low (template)  
**Risk:** None  
**Est Time:** 5 min

---

### Phase N: Documentation üìù HIGH VALUE

#### Architecture Doc (docs/ARCHITECTURE.md)
**Goal:** Comprehensive system design doc

**Outline:**
1. Overview
   - v2.0 ‚Üí v2.1 evolution
   - Core principles (observability, resilience, caching)
2. DAG Execution
   - Node types, dependencies
   - Parallelism model
   - Execution phases
3. Provider Abstraction
   - LLMProvider protocol
   - Adapters (Ollama, OpenAI, Anthropic, MLX)
   - Retry/timeout strategy (Part 2)
4. Events System
   - Event schema (TypedDict)
   - Event types (job.*, step.*, llm.*, file.*, cache.*)
   - ND-JSON format
5. Caching Strategy
   - Deterministic keys
   - Code versioning
   - Cache invalidation
6. Resume-from-Failure
   - Checkpoint mechanism
   - events.jsonl as source of truth
   - Idempotency guarantees
7. Run Folder Structure
   - manifest.json
   - events.jsonl
   - outputs/, logs/, .cache/

**Complexity:** High  
**Est Time:** 30 min  
**Value:** ‚≠ê‚≠ê‚≠ê Very High (developer onboarding)

#### Migration Doc (docs/MIGRATION_v1_to_v2.md)
**Goal:** Guide users from v1.x to v2.x

**Outline:**
1. Breaking Changes
   - FileStore signature change
   - Event field rename (timestamp ‚Üí ts)
   - Manifest new fields
2. New Features
   - Resume with `--resume` flag
   - Cache for faster runs
   - Enhanced events
3. Migration Steps
   - Update code using FileStore
   - Handle new manifest fields
   - Opt into caching
4. Backward Compatibility
   - What still works
   - Deprecation timeline

**Complexity:** Medium  
**Est Time:** 20 min  
**Value:** ‚≠ê‚≠ê‚≠ê High (smooth migration)

#### Contributing Doc (CONTRIBUTING.md)
**Goal:** Dev setup and contribution guidelines

**Outline:**
1. Development Setup
   - Clone, venv, install
   - Run tests
   - Install pre-commit hooks
2. Project Structure
   - src/ overview
   - tests/ conventions
   - docs/ organization
3. Testing
   - pytest usage
   - Writing new tests
   - Golden tests
4. Code Style
   - black, ruff
   - Type hints (Python 3.11+)
5. Commit Conventions
   - Conventional Commits format
   - feat/fix/docs/test/ci prefixes
   - Scope (events/dag/cache/providers)
6. Pull Request Process
   - Feature branches
   - CI must pass
   - Code review expectations

**Complexity:** Medium  
**Est Time:** 20 min  
**Value:** ‚≠ê‚≠ê Medium (community growth)

#### Changelog (CHANGELOG.md)
**Goal:** Keep a Changelog format

**Template:**
```markdown
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added (v2.1.0)
- Typed Event schema with ts, level, job_id, type fields
- Resume-from-failure with `--resume` flag
- Deterministic caching with code versioning
- llm.request/response events for provider tracking
- file.written events with metadata
- cache.hit/miss events
- CLI `tail` command with filters (Part 2)
- CLI `show` command enhancements (Part 2)
- Circuit breaker for provider reliability (Part 2)

### Changed
- FileStore.safe_write() now returns dict with metadata
- Event field renamed: timestamp ‚Üí ts
- Manifest includes completed_steps and pending_steps

### Fixed
- [To be filled during bug fixes]

## [2.0.0] - 2025-10-15

### Added
- DAG-based parallel execution
- Provider abstraction (Ollama, OpenAI, Anthropic, MLX)
- Event logging system
- Run manifest with metadata
- Safe file I/O with SHA256 hashing
- CLI with run/show commands

[Unreleased]: https://github.com/user/unified_orchestrator/compare/v2.0.0...HEAD
[2.0.0]: https://github.com/user/unified_orchestrator/releases/tag/v2.0.0
```

**Complexity:** Low (templated)  
**Est Time:** 10 min  
**Value:** ‚≠ê‚≠ê‚≠ê High (release tracking)

#### README Update
**Goal:** Update with v2.1 features

**Changes Needed:**
1. Update version badge: v2.1.0
2. Add "What's New in v2.1" section:
   - Resume-from-failure
   - Deterministic caching
   - Enhanced observability
   - Circuit breaker (Part 2)
   - CLI improvements (Part 2)
3. Update CLI examples:
   ```bash
   # Resume failed job
   orchestrator run --spec job.yaml --resume
   
   # Tail events
   orchestrator tail <job_id> --type llm.response
   ```
4. Add caching example
5. Update run folder diagram (add .cache/)

**Complexity:** Low  
**Est Time:** 10 min  
**Value:** ‚≠ê‚≠ê‚≠ê Very High (first impression)

---

## üé® Commit Strategy

### Recommended Atomic Commits

```bash
# Commit 1: FileStore Events
feat(filestore): return metadata dict and emit file.written events

# Commit 2: FileStore Tests  
test(filestore): verify idempotency and nochange behavior

# Commit 3: Resume Tests
test(resume): verify resume skips completed steps

# Commit 4: Cache Tests
test(cache): verify deterministic keys and cache hits

# Commit 5: CI Polish
ci: verify caching and artifact upload, add explicit golden test step

# Commit 6: Configuration
docs: add .env.example with provider config

# Commit 7: Documentation
docs: comprehensive architecture, migration, and contribution guides

# Commit 8: Changelog + README
docs: add CHANGELOG.md and update README for v2.1
```

**Total:** 8 commits (14 tasks, excluding Phase J)

---

## üö® Risk Assessment

### High Risk
- ‚ùå **Phase J blocked by Part 2** - Cannot proceed
- ‚ö†Ô∏è **FileStore breaking change** - Need migration path

### Medium Risk
- ‚ö†Ô∏è **Resume tests complexity** - Mocking DAG execution tricky
- ‚ö†Ô∏è **Documentation completeness** - Easy to miss details

### Low Risk
- ‚úÖ Cache tests - Well-defined, isolated
- ‚úÖ FileStore idempotency tests - Straightforward
- ‚úÖ CI verification - Already mostly done
- ‚úÖ Configuration - Simple template

---

## ‚úÖ Pre-Implementation Checklist

### Before Starting Part 3

- [x] Part 1 completed and committed
- [ ] Part 2 completed (for Phase J) - **SKIP Phase J for now**
- [x] All Part 1 tests pass
- [ ] Smoke test Part 1 manually
- [ ] Review FileStore breaking change strategy

### Implementation Readiness

**CAN START IMMEDIATELY (14/16 tasks):**
- ‚úÖ Phases H, I, K, L, M, N (all except Phase J)

**MUST DEFER (2/16 tasks):**
- ‚ùå Phase J - Retry/Circuit Breaker Tests

---

## üìä Success Metrics

### Tests
- [ ] +8 new test functions
- [ ] All existing tests still pass
- [ ] Test coverage for Part 1 features: events, resume, cache
- [ ] CI green on both ubuntu + macos, Python 3.11 + 3.12

### Documentation
- [ ] ARCHITECTURE.md explains all v2.1 systems
- [ ] MIGRATION.md guides v1 ‚Üí v2 upgrade
- [ ] CONTRIBUTING.md enables new contributors
- [ ] CHANGELOG.md tracks all changes
- [ ] README.md showcases v2.1 features

### CI/CD
- [ ] Pip dependencies cached (already done)
- [ ] Test artifacts uploaded on failure (already done)
- [ ] Golden tests run explicitly (verify)

---

## üéØ Recommendation: Proceed with Modified Part 3

### Scope Adjustment

**Implement Now (14 tasks):**
```
‚úÖ Phase H: FileStore Tests (2)
‚úÖ Phase I: Resume Tests (2)
‚è≠Ô∏è  Phase J: SKIP - defer to post-Part 2
‚úÖ Phase K: Cache Tests (2)
‚úÖ Phase L: CI Polish (3)
‚úÖ Phase M: Configuration (1)
‚úÖ Phase N: Documentation (5)
```

**Defer Until Part 2 Complete (2 tasks):**
```
‚è∏Ô∏è test-retries-file
‚è∏Ô∏è test-retries-circuit
```

### Updated Timeline

**Estimated Time:** 2.5 hours (was 3 hours)  
**Commits:** 8 atomic commits  
**Tests Added:** 6 new tests (will be 8 after Part 2)

### Final Review Verdict

‚úÖ **APPROVED TO PROCEED** with scope adjustment  
‚ö†Ô∏è **DEFER Phase J** until Part 2 completion  
‚úÖ **HIGH VALUE** - Makes v2.1 production-ready  
‚úÖ **LOW RISK** - Well-defined tasks, clear acceptance criteria

---

**Ready to implement? Confirm and I'll start with Wave 1 (Foundation).**


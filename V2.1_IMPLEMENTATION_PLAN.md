# v2.1 "Hardening + UX" - Implementation Plan

**Target Version:** 2.1.0  
**Focus:** Reliability, Observability, Resume, CLI UX, Documentation  
**Tasks:** 38 atomic subtasks  
**Estimated Time:** 4-6 hours  

---

## üìã Task Breakdown (38 Tasks)

### Phase A: Events Schema + Emit (5 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `event-types` | Define Event TypedDict | `src/core/events.py` | TypedDict with ts, level, job_id, type, step, data |
| `event-emit-enhanced` | Validate & add timestamps to emit() | `src/core/events.py` | emit() adds ISO8601 ts if missing |
| `event-llm-methods` | Add llm_request/response methods | `src/core/events.py` | Methods emit llm.request and llm.response |
| `event-file-methods` | Add file_written method | `src/core/events.py` | Emits file.written with path, sha256, wrote, reason |
| `event-cache-methods` | Add cache_hit/miss methods | `src/core/events.py` | Emits cache.hit and cache.miss |

**Commit Message:** `feat(events): typed event schema with llm/file/cache events`

---

### Phase B: CLI Enhancements (3 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `cli-show-events` | Derive step statuses from events | `src/cli.py` | show command reads events.jsonl to display step states |
| `cli-tail-command` | Add tail command with filters | `src/cli.py` | tail <job_id> --type --step --level flags work |
| `cli-tail-follow` | Implement follow mode | `src/cli.py` | tail -f streams new events in real-time |

**Commit Message:** `feat(cli): enhanced show + new tail command with filters`

---

### Phase C: Resume from Failure (4 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `manifest-resume-fields` | Add completed/pending steps to manifest | `src/core/manifest.py` | Manifest has completed_steps, pending_steps lists |
| `dag-resume-read` | Implement read_completed_steps() | `src/core/dag.py` | Function reads events.jsonl, returns completed set |
| `dag-resume-logic` | Add resume parameter to run_dag() | `src/core/dag.py` | resume=True skips steps in completed set |
| `cli-resume-flag` | Add --resume flag to run command | `src/cli.py` | orchestrator run --resume works |

**Commit Message:** `feat(resume): resume failed jobs from last checkpoint`

---

### Phase D: Provider Reliability (5 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `ollama-timeout` | Add httpx.Timeout to Ollama | `src/providers/ollama.py` | Respects PROVIDER_TIMEOUT_S env var |
| `openai-timeout` | Add httpx.Timeout to OpenAI | `src/providers/openai.py` | Respects PROVIDER_TIMEOUT_S env var |
| `anthropic-timeout` | Add httpx.Timeout to Anthropic | `src/providers/anthropic.py` | Respects PROVIDER_TIMEOUT_S env var |
| `circuit-breaker-class` | Create CircuitBreaker | `src/core/circuit_breaker.py` | Class with open/close/half_open states |
| `provider-breaker-integration` | Integrate breaker in providers | All provider files | generate() checks breaker before calling |

**Commit Message:** `feat(providers): timeouts + circuit breaker for reliability`

---

### Phase E: LLM Events (1 task)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `provider-llm-events` | Emit llm.request/response | All providers | Each generate() call emits request/response events |

**Commit Message:** `feat(events): llm request/response tracking`

---

### Phase F: Deterministic Caching (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `cache-key-function` | Create compute_cache_key() | `src/core/cache.py` (new) | Key = SHA256(provider+step+inputs+git_version) |
| `cache-integration` | Integrate in orchestrator | `src/orchestrator/dag_orchestrator.py` | Steps check cache before LLM call, emit cache.hit/miss |

**Commit Message:** `feat(cache): deterministic cache keys with version tracking`

---

### Phase G: FileStore Events (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `filestore-return-metadata` | Return metadata dict from safe_write | `src/core/filestore.py` | Returns {path, sha256, wrote: bool, reason: str} |
| `filestore-emit-events` | Emit file.written events | `src/core/filestore.py` | Takes optional EventEmitter, emits on write |

**Commit Message:** `feat(filestore): emit file.written events with metadata`

---

### Phase H: FileStore Tests (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `test-filestore-idempotency` | Test idempotency preserves hash | `tests/test_filestore.py` | test_idempotency_preserves_manifest_hash() |
| `test-filestore-nochange` | Test nochange reason returned | `tests/test_filestore.py` | test_safe_write_nochange_reason() checks wrote=False |

**Commit Message:** `test(filestore): verify idempotency and nochange behavior`

---

### Phase I: Resume Tests (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `test-resume-file` | Create resume test file | `tests/test_resume.py` | test_resume_skips_completed_steps() passes |
| `test-resume-integration` | Test resume after failure | `tests/test_resume.py` | test_resume_after_failure() simulates fail + resume |

**Commit Message:** `test(resume): verify resume skips completed steps`

---

### Phase J: Retry/Circuit Breaker Tests (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `test-retries-file` | Create retries test file | `tests/test_retries.py` | test_provider_retries_on_timeout() with mock |
| `test-retries-circuit` | Test circuit breaker | `tests/test_retries.py` | test_circuit_breaker_opens_after_threshold() |

**Commit Message:** `test(providers): verify retries and circuit breaker`

---

### Phase K: Cache Tests (2 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `test-cache-file` | Create cache test file | `tests/test_cache.py` | test_cache_key_deterministic() |
| `test-cache-hits` | Test cache reuse | `tests/test_cache.py` | test_second_run_uses_cache() checks cache.hit event |

**Commit Message:** `test(cache): verify deterministic keys and cache hits`

---

### Phase L: CI Polish (3 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `ci-pip-cache` | Add pip caching | `.github/workflows/ci.yml` | actions/cache@v3 with pip cache key |
| `ci-artifact-upload` | Upload runs/ on failure | `.github/workflows/ci.yml` | actions/upload-artifact@v3 if tests fail |
| `ci-golden-explicit` | Explicit golden test step | `.github/workflows/ci.yml` | pytest tests/test_golden.py step |

**Commit Message:** `ci: add caching and artifact upload on failure`

---

### Phase M: Configuration (1 task)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `env-example-file` | Create .env.example | `.env.example` (new) | Has PROVIDER_TIMEOUT_S, MAX_RETRIES, CB_THRESHOLD, CB_COOLDOWN_S |

**Commit Message:** `docs: add .env.example with provider config`

---

### Phase N: Documentation (5 tasks)

| ID | Task | File | Acceptance |
|----|------|------|------------|
| `architecture-doc-file` | Create ARCHITECTURE.md | `docs/ARCHITECTURE.md` (new) | Documents DAG, providers, events, cache, resume |
| `migration-doc-file` | Create MIGRATION guide | `docs/MIGRATION_v1_to_v2.md` (new) | Lists breaking changes + migration examples |
| `contributing-doc-file` | Create CONTRIBUTING.md | `CONTRIBUTING.md` (new) | Dev setup, testing, commit conventions |
| `changelog-file` | Create CHANGELOG.md | `CHANGELOG.md` (new) | Keep a Changelog format with v2.0.0 + Unreleased |
| `readme-update-v21` | Update README for v2.1 | `README.md` | Add resume, tail, circuit breaker features |

**Commit Message:** `docs: comprehensive architecture, migration, and contribution guides`

---

## üéØ Implementation Order (for Claude Code CLI / Codex)

### Batch 1: Events Foundation (5 tasks)
```
event-types ‚Üí event-emit-enhanced ‚Üí event-llm-methods ‚Üí event-file-methods ‚Üí event-cache-methods
```

### Batch 2: CLI UX (3 tasks)
```
cli-show-events ‚Üí cli-tail-command ‚Üí cli-tail-follow
```

### Batch 3: Resume Capability (4 tasks)
```
manifest-resume-fields ‚Üí dag-resume-read ‚Üí dag-resume-logic ‚Üí cli-resume-flag
```

### Batch 4: Provider Reliability (8 tasks)
```
ollama-timeout ‚Üí openai-timeout ‚Üí anthropic-timeout ‚Üí
circuit-breaker-class ‚Üí provider-breaker-integration ‚Üí provider-llm-events
```

### Batch 5: Deterministic Cache (2 tasks)
```
cache-key-function ‚Üí cache-integration
```

### Batch 6: FileStore Events (2 tasks)
```
filestore-return-metadata ‚Üí filestore-emit-events
```

### Batch 7: Tests - FileStore (2 tasks)
```
test-filestore-idempotency ‚Üí test-filestore-nochange
```

### Batch 8: Tests - Resume (2 tasks)
```
test-resume-file ‚Üí test-resume-integration
```

### Batch 9: Tests - Retries (2 tasks)
```
test-retries-file ‚Üí test-retries-circuit
```

### Batch 10: Tests - Cache (2 tasks)
```
test-cache-file ‚Üí test-cache-hits
```

### Batch 11: CI Polish (3 tasks)
```
ci-pip-cache ‚Üí ci-artifact-upload ‚Üí ci-golden-explicit
```

### Batch 12: Configuration (1 task)
```
env-example-file
```

### Batch 13: Documentation (5 tasks)
```
architecture-doc-file ‚Üí migration-doc-file ‚Üí contributing-doc-file ‚Üí
changelog-file ‚Üí readme-update-v21
```

---

## üîß Implementation Instructions for AI Tools

### For Claude Code CLI:
```bash
# Process each batch sequentially
claude-code implement --task event-types --file src/core/events.py
claude-code implement --task event-emit-enhanced --file src/core/events.py
# ... etc
```

### For Codex:
```
# Provide context for each task
Context: src/core/events.py defines EventEmitter class
Task: Add Event TypedDict with fields: ts (str), level (Literal), job_id (str), type (str), step (NotRequired[str]), data (NotRequired[dict])
Acceptance: TypedDict validates event structure
```

### Task Dependencies:

**No Dependencies (can run first):**
- event-types
- manifest-resume-fields
- ollama-timeout, openai-timeout, anthropic-timeout
- circuit-breaker-class
- env-example-file
- All doc tasks (architecture, migration, contributing, changelog)

**Sequential Dependencies:**
- event-emit-enhanced requires event-types
- event-llm-methods requires event-emit-enhanced
- cli-tail-command requires event-types
- dag-resume-logic requires dag-resume-read
- provider-breaker-integration requires circuit-breaker-class
- cache-integration requires cache-key-function
- All test tasks require their respective features implemented

---

## üìù File-by-File Implementation Guide

### File: src/core/events.py (6 changes)
1. Add Event TypedDict import and definition
2. Update emit() to validate Event and add timestamps
3. Add llm_request() method
4. Add llm_response() method
5. Add file_written() method
6. Add cache_hit() and cache_miss() methods

### File: src/cli.py (3 changes)
1. Update show() to parse events.jsonl and derive step statuses
2. Add tail() command with filter flags
3. Implement follow mode (watch events.jsonl for new lines)

### File: src/core/manifest.py (1 change)
1. Add completed_steps and pending_steps fields to manifest schema

### File: src/core/dag.py (2 changes)
1. Add read_completed_steps(events_path) helper function
2. Add resume parameter to run_dag(), skip completed steps if resume=True

### File: src/providers/*.py (3 changes per provider = 12 total)
1. Add httpx.Timeout configuration
2. Integrate CircuitBreaker
3. Emit llm.request/response events

### File: src/core/circuit_breaker.py (NEW)
1. Create CircuitBreaker class with open/close/half_open states

### File: src/core/cache.py (NEW)
1. Create compute_cache_key() function

### File: src/orchestrator/dag_orchestrator.py (1 change)
1. Integrate cache checking in steps

### File: src/core/filestore.py (2 changes)
1. Update safe_write() return type to include metadata dict
2. Add optional EventEmitter parameter and emit file.written

### Test Files (8 new files/additions)
- tests/test_filestore.py: +2 tests
- tests/test_resume.py: NEW file, 2 tests
- tests/test_retries.py: NEW file, 2 tests
- tests/test_cache.py: NEW file, 2 tests

### CI/CD (3 changes)
- .github/workflows/ci.yml: pip cache, artifact upload, golden tests

### Documentation (5 new files)
- .env.example
- docs/ARCHITECTURE.md
- docs/MIGRATION_v1_to_v2.md
- CONTRIBUTING.md
- CHANGELOG.md

---

## üéØ Quick Reference for Each Task

### Example: event-types
```python
# File: src/core/events.py
# Action: Add after imports

from typing import TypedDict, Literal, NotRequired

class Event(TypedDict):
    """Typed event structure"""
    ts: str  # ISO8601 timestamp
    level: Literal["INFO", "WARN", "ERROR"]
    job_id: str
    type: str  # e.g., "step.started", "llm.request"
    step: NotRequired[str]
    data: NotRequired[dict]
```

### Example: cli-tail-command
```python
# File: src/cli.py
# Action: Add new command

@app.command()
def tail(
    job_id: str,
    type_filter: Optional[str] = typer.Option(None, "--type"),
    step_filter: Optional[str] = typer.Option(None, "--step"),
    level_filter: Optional[str] = typer.Option(None, "--level"),
    follow: bool = typer.Option(False, "-f", "--follow")
):
    """Follow events from a job in real-time"""
    events_path = Path(f"runs/{job_id}/events.jsonl")
    # Implementation...
```

### Example: test-resume-file
```python
# File: tests/test_resume.py
# Action: Create new test file

import pytest
from src.core.dag import run_dag, read_completed_steps

@pytest.mark.asyncio
async def test_resume_skips_completed_steps():
    """Resume should skip steps that already succeeded"""
    # Simulate first run with failure
    # Write events.jsonl with architect=succeeded, builder=failed
    # Run with resume=True
    # Assert architect not re-executed
    # Assert builder re-executed
    pass
```

---

## üîÑ Execution Strategy

### For Manual Implementation:
1. Work through batches 1-13 in order
2. Commit after each batch
3. Run tests after batches 7-10
4. Update docs last (batch 13)

### For Claude Code CLI:
```bash
# Run each task with context
for task in event-types event-emit-enhanced ...; do
    claude-code implement --task $task --context "v2.1 implementation"
done
```

### For Codex:
- Process each batch as a unit
- Provide full context for each file
- Validate with tests after code changes
- Generate docs last

---

## ‚úÖ Acceptance Criteria Summary

**Events:**
- [ ] Event TypedDict defined with all required fields
- [ ] emit() adds timestamps automatically
- [ ] llm.request/response events emitted by providers
- [ ] file.written events emitted by filestore
- [ ] cache.hit/miss events emitted

**CLI:**
- [ ] `orchestrator show <job_id>` displays step statuses from events
- [ ] `orchestrator tail <job_id>` streams events
- [ ] Filters work: --type step.started, --step builder, --level ERROR

**Resume:**
- [ ] `orchestrator run --resume` skips completed steps
- [ ] manifest.json tracks completed/pending steps
- [ ] Events show which steps were skipped vs re-executed

**Reliability:**
- [ ] All providers have configurable timeouts (PROVIDER_TIMEOUT_S)
- [ ] Circuit breaker opens after N consecutive failures
- [ ] Retries use exponential backoff with jitter

**Caching:**
- [ ] Cache keys are deterministic (same inputs = same key)
- [ ] Second run with same inputs shows cache.hit events
- [ ] Cache stored in runs/<job_id>/.cache/

**Tests:**
- [ ] All new tests pass (target: +15 tests)
- [ ] Existing 39 tests still pass
- [ ] Golden tests remain green

**CI:**
- [ ] Pip dependencies cached
- [ ] runs/ directory uploaded on test failure
- [ ] Golden tests run explicitly

**Docs:**
- [ ] ARCHITECTURE.md explains all systems
- [ ] MIGRATION.md guides v1‚Üív2 upgrade
- [ ] CONTRIBUTING.md helps new developers
- [ ] CHANGELOG.md follows Keep a Changelog format

---

## üìä Progress Tracking

Total Tasks: 38
- Phase A (Events): 5 tasks
- Phase B (CLI): 3 tasks
- Phase C (Resume): 4 tasks
- Phase D (Providers): 5 tasks
- Phase E (LLM Events): 1 task
- Phase F (Cache): 2 tasks
- Phase G (FileStore): 2 tasks
- Phase H-K (Tests): 8 tasks
- Phase L (CI): 3 tasks
- Phase M (Config): 1 task
- Phase N (Docs): 5 tasks

---

**Ready for implementation with Claude Code CLI, Codex, or manual coding!**

Each task is:
- ‚úÖ Atomic (single responsibility)
- ‚úÖ Specific (exact file path)
- ‚úÖ Testable (clear acceptance criteria)
- ‚úÖ Independent (minimal dependencies)

